<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa Educativo — Ecuador</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <style>
    body { margin:0; font-family:system-ui,Arial; }
    header { 
      background: linear-gradient(135deg,#667eea,#764ba2); 
      color: #fff; 
      padding: 12px 16px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #map { 
      height: calc(100vh - 60px); 
      width: 100vw; 
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 250px;
    }
    .control-panel h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
    }
    .control-panel button {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: #1976d2;
      color: white;
      cursor: pointer;
      font-size: 12px;
    }
    .control-panel button:hover {
      background: #1565c0;
    }
    .stats {
      font-size: 12px;
      margin-top: 10px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0">🇪🇨 Mapa Educativo — Ecuador</h2>
    <small>Provincias (polígonos) + Instituciones Educativas (puntos) + Distritos</small>
  </header>
  
  <div id="loading" class="loading">
    <div>📍 Cargando mapa educativo...</div>
  </div>

  <div class="control-panel">
    <h3>🎛️ Controles</h3>
    <button onclick="toggleProvincias()">👁️ Mostrar/Ocultar Provincias</button>
    <button onclick="toggleInstituciones()">🏫 Mostrar/Ocultar Instituciones</button>
    <button onclick="toggleDistritos()">🏛️ Mostrar/Ocultar Distritos</button>
    <button onclick="resetView()">🔄 Centrar Mapa</button>
    <div class="stats" id="stats">
      <div>📊 Estadísticas del mapa</div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // Configuración del mapa
    const map = L.map('map').setView([-1.8312, -78.1834], 6);
    
    // Capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors | 🇪🇨 Mapa Educativo Ecuador', 
      maxZoom: 18
    }).addTo(map);

    // Variables para capas
    let provLayer, instLayer, distLayer;
    let cluster;
    let stats = { provincias: 0, instituciones: 0, distritos: 0 };

    // Función para actualizar estadísticas
    function updateStats() {
      document.getElementById('stats').innerHTML = `
        <div>📊 Estadísticas:</div>
        <div>🏛️ Provincias: ${stats.provincias}</div>
        <div>🏫 Instituciones: ${stats.instituciones}</div>
        <div>📍 Distritos: ${stats.distritos}</div>
      `;
    }

    // Cargar provincias (opcional)
    fetch('data/provincias.geojson')
      .then(r => r.ok ? r.json() : Promise.reject('Archivo no encontrado'))
      .then(geo => {
        stats.provincias = geo.features ? geo.features.length : 0;
        provLayer = L.geoJSON(geo, { 
          style: { 
            color: '#555', 
            weight: 2, 
            fillOpacity: 0.1,
            fillColor: '#667eea'
          },
          onEachFeature: (feature, layer) => {
            const props = feature.properties || {};
            const nombre = props.DPA_DESPRO || props.NOMBRE || 'Provincia';
            layer.bindPopup(`<b>🏛️ ${nombre}</b><br>Provincia del Ecuador`);
          }
        }).addTo(map);
        
        // Ajustar vista al mapa
        map.fitBounds(provLayer.getBounds(), {padding:[20,20]});
        updateStats();
      })
      .catch(err => {
        console.warn('⚠️ provincias.geojson no encontrado (se omite):', err);
      });

    // Cargar instituciones educativas con clustering
    cluster = L.markerClusterGroup({ 
      chunkedLoading: true, 
      showCoverageOnHover: false, 
      maxClusterRadius: 50,
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();
        let size = 'small';
        if (count > 100) size = 'large';
        else if (count > 10) size = 'medium';
        
        return new L.DivIcon({
          html: `<div><span>${count}</span></div>`,
          className: 'marker-cluster marker-cluster-' + size,
          iconSize: new L.Point(40, 40)
        });
      }
    });

    fetch('data/instituciones.geojson')
      .then(r => r.ok ? r.json() : Promise.reject('Archivo no encontrado'))
      .then(gj => {
        stats.instituciones = gj.features ? gj.features.length : 0;
        
        instLayer = L.geoJSON(gj, {
          pointToLayer: (feat, latlng) => {
            const props = feat.properties || {};
            const sostenimiento = props.NOM_SOSTENIMIENTO || '';
            
            // Color según sostenimiento
            let color = '#1976d2'; // Default azul
            if (sostenimiento.includes('FISCAL')) color = '#2e7d32'; // Verde
            else if (sostenimiento.includes('PARTICULAR')) color = '#d32f2f'; // Rojo
            else if (sostenimiento.includes('FISCOMISIONAL')) color = '#f57c00'; // Naranja
            
            return L.circleMarker(latlng, {
              radius: 6, 
              color: '#fff', 
              weight: 1.5, 
              fillColor: color, 
              fillOpacity: 0.95
            });
          },
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const nombre = p.NOM_INSTITUCION_EDUCATIVA || 'Institución';
            const sost = p.NOM_SOSTENIMIENTO || '—';
            const prov = p.DPA_DESPRO || '—';
            const canton = p.DPA_DESCAN || '—';
            const reg = p.REGIMEN || '—';
            const est = (p.TOTAL_ESTUDIANTES != null) ? Number(p.TOTAL_ESTUDIANTES).toLocaleString() : '—';
            const amie = p.AMIE || '—';
            const zona = p.ZONA || '—';
            
            const popupContent = `
              <div style="max-width: 300px;">
                <h3 style="margin: 0 0 10px 0; color: #1976d2;">🏫 ${nombre}</h3>
                <hr style="margin: 8px 0;">
                <div><b>📋 AMIE:</b> ${amie}</div>
                <div><b>🏢 Sostenimiento:</b> ${sost}</div>
                <div><b>🏛️ Provincia:</b> ${prov}</div>
                <div><b>🏘️ Cantón:</b> ${canton}</div>
                <div><b>📚 Régimen:</b> ${reg}</div>
                <div><b>👥 Estudiantes:</b> ${est}</div>
                <div><b>🗺️ Zona:</b> ${zona}</div>
              </div>
            `;
            
            layer.bindPopup(popupContent);
          }
        });
        
        cluster.addLayer(instLayer);
        map.addLayer(cluster);
        updateStats();
      })
      .catch(err => {
        console.warn('⚠️ instituciones.geojson no encontrado:', err);
        document.getElementById('loading').innerHTML = `
          <div style="text-align: center;">
            <h3>⚠️ Datos no encontrados</h3>
            <p>Para ver las instituciones educativas, sube el archivo <code>instituciones.geojson</code> a la carpeta <code>data/</code></p>
            <p>Para generar este archivo, usa el script Python incluido en el proyecto.</p>
          </div>
        `;
        setTimeout(() => {
          document.getElementById('loading').style.display = 'none';
        }, 5000);
      });

    // Cargar distritos educativos (desde nuestro análisis Python)
    fetch('data/distritos.geojson')
      .then(r => r.ok ? r.json() : Promise.reject('Archivo no encontrado'))
      .then(gj => {
        stats.distritos = gj.features ? gj.features.length : 0;
        
        distLayer = L.geoJSON(gj, {
          pointToLayer: (feat, latlng) => {
            return L.marker(latlng, {
              icon: L.divIcon({
                html: '<div style="background: #ff5722; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">D</div>',
                iconSize: [20, 20],
                className: 'distrito-marker'
              })
            });
          },
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const codigo = p.COD_DISTRI || '—';
            const nombre = p.NOM_DISTRI || 'Distrito';
            const provincia = p.DPA_DESPRO || '—';
            const canton = p.DPA_DESCAN || '—';
            const zona = p.ZONA || '—';
            const direccion = p.DIRECCION || '—';
            const capital = p.Capital_Pr || '—';
            
            const popupContent = `
              <div style="max-width: 300px;">
                <h3 style="margin: 0 0 10px 0; color: #ff5722;">🏛️ ${codigo} - ${nombre}</h3>
                <hr style="margin: 8px 0;">
                <div><b>🏛️ Provincia:</b> ${provincia}</div>
                <div><b>🏘️ Cantón:</b> ${canton}</div>
                <div><b>🗺️ Zona:</b> ${zona}</div>
                <div><b>⭐ Capital:</b> ${capital}</div>
                <div><b>📧 Dirección:</b> ${direccion}</div>
              </div>
            `;
            
            layer.bindPopup(popupContent);
          }
        });
        
        // No agregamos automáticamente, solo si el usuario quiere
        updateStats();
      })
      .catch(err => {
        console.warn('⚠️ distritos.geojson no encontrado:', err);
      });

    // Funciones de control
    function toggleProvincias() {
      if (provLayer) {
        if (map.hasLayer(provLayer)) {
          map.removeLayer(provLayer);
        } else {
          map.addLayer(provLayer);
        }
      }
    }

    function toggleInstituciones() {
      if (cluster) {
        if (map.hasLayer(cluster)) {
          map.removeLayer(cluster);
        } else {
          map.addLayer(cluster);
        }
      }
    }

    function toggleDistritos() {
      if (distLayer) {
        if (map.hasLayer(distLayer)) {
          map.removeLayer(distLayer);
        } else {
          map.addLayer(distLayer);
        }
      }
    }

    function resetView() {
      map.setView([-1.8312, -78.1834], 6);
    }

    // Ocultar loading cuando el mapa esté listo
    map.whenReady(() => {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
      }, 2000);
    });

    // Actualizar stats inicialmente
    updateStats();
  </script>
</body>
</html>