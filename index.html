<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Ejecutivo — Sistema Geoespacial de Distritos Educativos (EC)</title>

<!-- Leaflet + MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<!-- PapaParse para leer CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- TopoJSON -->
<script src="https://unpkg.com/topojson-client@3"></script>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Configuración -->
<script>window.EXPECTED_TOTAL = 140;</script>

<style>
  :root{
    --bg-primary: #0B1426;
    --bg-secondary: #111827;
    --bg-card: #1F2937;
    --bg-card-hover: #274162;
    --accent-blue: #3B82F6;
    --accent-cyan: #06B6D4;
    --accent-purple: #8B5CF6;
    --accent-green: #10B981;
    --accent-orange: #F59E0B;
    --accent-red: #EF4444;
    --text-primary: #F9FAFB;
    --text-secondary: #D1D5DB;
    --text-muted: #9CA3AF;
    --border: #374151;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
  }

  .container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Header Mejorado */
  .header {
    background: var(--gradient-primary);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    opacity: 0.3;
  }

  .header-content {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 25px;
  }

  .header-logo {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 800;
    color: white;
    backdrop-filter: blur(10px);
  }

  .header-info h1 {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 8px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .header-stats {
    display: flex;
    gap: 30px;
    margin-top: 15px;
  }

  .header-stat {
    text-align: center;
  }

  .header-stat-value {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
  }

  .header-stat-label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Grid Principal */
  .main-grid {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }

  /* Panel de Control */
  .control-panel {
    background: var(--bg-card);
    border-radius: 20px;
    padding: 25px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    height: fit-content;
  }

  .panel-section {
    margin-bottom: 25px;
  }

  .panel-section:last-child {
    margin-bottom: 0;
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-box {
    width: 100%;
    padding: 14px 18px;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .search-box:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
  }

  .select-box {
    width: 100%;
    padding: 12px 15px;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
  }

  /* Chips Mejorados */
  .chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .chip {
    padding: 8px 16px;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
  }

  .chip:hover {
    background: var(--bg-card-hover);
    transform: translateY(-1px);
  }

  .chip.active {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  /* Estadísticas Rápidas */
  .quick-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
  }

  .stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-blue);
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Botones */
  .button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn-primary {
    background: var(--accent-blue);
    color: white;
  }

  .btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border);
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* Mapa */
  .map-container {
    background: var(--bg-card);
    border-radius: 20px;
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  #map {
    height: 70vh;
    width: 100%;
    border-radius: 16px;
    border: 2px solid var(--border);
  }

  /* Dashboard Ejecutivo */
  .executive-dashboard {
    margin-top: 30px;
  }

  .dashboard-title {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 25px;
    color: var(--text-primary);
    text-align: center;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
  }

  .dashboard-card {
    background: var(--bg-card);
    border-radius: 20px;
    padding: 25px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: all 0.3s ease;
  }

  .dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .card-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }

  .card-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
  }

  /* KPIs Grid */
  .kpis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
  }

  .kpi-card {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card-hover));
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--gradient-primary);
  }

  .kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }

  .kpi-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--accent-blue);
    margin-bottom: 8px;
    line-height: 1;
  }

  .kpi-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .kpi-change {
    font-size: 12px;
    margin-top: 5px;
    font-weight: 600;
  }

  .kpi-change.positive {
    color: var(--accent-green);
  }

  .kpi-change.negative {
    color: var(--accent-red);
  }

  /* Gráficos */
  .chart-container {
    height: 280px;
    position: relative;
    margin-top: 15px;
  }

  .chart-small {
    height: 200px;
  }

  /* Tabla de Datos */
  .data-table {
    max-height: 250px;
    overflow-y: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-top: 15px;
  }

  .data-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th,
  .data-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .data-table th {
    background: var(--bg-secondary);
    font-weight: 700;
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .data-table td {
    font-size: 14px;
    color: var(--text-primary);
  }

  .data-table tr:hover {
    background: var(--bg-secondary);
  }

  /* Panel de Detalles */
  .detail-panel {
    background: linear-gradient(135deg, var(--bg-card), var(--bg-card-hover));
    border: 2px solid var(--accent-blue);
    border-radius: 16px;
    padding: 20px;
    margin-top: 15px;
  }

  .detail-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-blue);
    margin-bottom: 15px;
  }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .detail-item {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .detail-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .detail-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
  }

  /* Leyenda del Mapa */
  .map-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
  }

  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  /* Loading */
  .loading {
    position: fixed;
    inset: 0;
    background: rgba(11, 20, 38, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
  }

  .loading-content {
    text-align: center;
    color: var(--text-primary);
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid var(--border);
    border-top: 3px solid var(--accent-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
    
    .dashboard-grid {
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    }
  }

  @media (max-width: 768px) {
    .container {
      padding: 15px;
    }
    
    .header-content {
      flex-direction: column;
      text-align: center;
    }
    
    .header-stats {
      justify-content: center;
    }
    
    .filter-row {
      grid-template-columns: 1fr;
    }
    
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
    
    .kpis-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* Animaciones */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-in {
    animation: fadeIn 0.6s ease-out;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .pulse {
    animation: pulse 2s infinite;
  }
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading" class="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <h3>Cargando Sistema Geoespacial</h3>
    <p>Conectando con base de datos y preparando visualizaciones...</p>
  </div>
</div>

<div class="container">
  <!-- Header Ejecutivo -->
  <header class="header fade-in">
    <div class="header-content">
      <div class="header-logo">EC</div>
      <div class="header-info">
        <h1>Sistema Geoespacial de Distritos Educativos</h1>
        <p style="opacity: 0.9; margin-bottom: 0;">Ministerio de Educación • República del Ecuador • 2025</p>
        <div class="header-stats">
          <div class="header-stat">
            <div class="header-stat-value" id="headerTotalDistritos">140</div>
            <div class="header-stat-label">Distritos Totales</div>
          </div>
          <div class="header-stat">
            <div class="header-stat-value" id="headerProvincias">24</div>
            <div class="header-stat-label">Provincias</div>
          </div>
          <div class="header-stat">
            <div class="header-stat-value" id="headerCantones">221</div>
            <div class="header-stat-label">Cantones</div>
          </div>
          <div class="header-stat">
            <div class="header-stat-value" id="headerCobertura">98.5%</div>
            <div class="header-stat-label">Cobertura Nacional</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Grid Principal -->
  <div class="main-grid">
    <!-- Panel de Control -->
    <aside class="control-panel fade-in">
      <div class="panel-section">
        <div class="section-title">
          🔍 Búsqueda Inteligente
        </div>
        <input id="searchInput" class="search-box" type="search" 
               placeholder="Buscar por código, nombre, provincia...">
      </div>

      <div class="panel-section">
        <div class="section-title">
          📍 Filtros Geográficos
        </div>
        <div class="filter-row">
          <select id="provinciaSelect" class="select-box">
            <option value="">Todas las Provincias</option>
          </select>
          <select id="cantonSelect" class="select-box">
            <option value="">Todos los Cantones</option>
          </select>
        </div>
      </div>

      <div class="panel-section">
        <div class="section-title">
          🏷️ Categorías Institucionales
        </div>
        <div id="categoryChips" class="chips-container"></div>
      </div>

      <div class="panel-section">
        <div class="section-title">
          📊 Estadísticas Rápidas
        </div>
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-value" id="totalRecords">—</div>
            <div class="stat-label">Total Registros</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="filteredRecords">—</div>
            <div class="stat-label">Filtrados</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="selectedProvince">—</div>
            <div class="stat-label">Provincia Activa</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="mapZoom">6</div>
            <div class="stat-label">Nivel de Zoom</div>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div class="section-title">
          ⚙️ Controles del Sistema
        </div>
        <div class="button-group">
          <button id="clearFilters" class="btn btn-secondary">Limpiar Filtros</button>
          <button id="toggleProvinces" class="btn btn-primary">Provincias: ON</button>
          <button id="exportData" class="btn btn-primary">Exportar CSV</button>
          <button id="refreshData" class="btn btn-secondary">Actualizar</button>
        </div>
      </div>

      <!-- Leyenda del Mapa -->
      <div class="map-legend">
        <div class="legend-item">
          <div class="legend-dot" style="background: #2563eb;"></div>
          MINEDUC
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #10b981;"></div>
          SENECYT
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #06b6d4;"></div>
          SENECYT - ZONA DEPORTE
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #f59e0b;"></div>
          ZONA DEPORTE
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #ef4444;"></div>
          OT DEPORTE
        </div>
      </div>
    </aside>

    <!-- Mapa Principal -->
    <main class="map-container fade-in">
      <div id="map"></div>
    </main>
  </div>

  <!-- Dashboard Ejecutivo -->
  <section class="executive-dashboard">
    <h2 class="dashboard-title">📈 Dashboard Ejecutivo de Inteligencia Geoespacial</h2>
    
    <div class="dashboard-grid">
      <!-- KPIs Principales -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-primary);">📊</div>
          <h3 class="card-title">Métricas Principales</h3>
        </div>
        <div class="kpis-grid">
          <div class="kpi-card">
            <div class="kpi-value" id="kpiTotalDistritos">—</div>
            <div class="kpi-label">Total Distritos</div>
            <div class="kpi-change positive">+2.3%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiProvincias">—</div>
            <div class="kpi-label">Provincias</div>
            <div class="kpi-change positive">100%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiCantones">—</div>
            <div class="kpi-label">Cantones</div>
            <div class="kpi-change positive">+1.1%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiVisible">—</div>
            <div class="kpi-label">Visible en Mapa</div>
            <div class="kpi-change positive">100%</div>
          </div>
        </div>
      </div>

      <!-- Distribución Geográfica -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-success);">🗺️</div>
          <h3 class="card-title">Distribución por Provincia</h3>
        </div>
        <div class="chart-container chart-small">
          <canvas id="provinciaChart"></canvas>
        </div>
      </div>

      <!-- Distribución Institucional -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-secondary);">🏛️</div>
          <h3 class="card-title">Distribución Institucional</h3>
        </div>
        <div class="chart-container chart-small">
          <canvas id="institutionChart"></canvas>
        </div>
      </div>

      <!-- Top Provincias -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--accent-orange);">🏆</div>
          <h3 class="card-title">Ranking de Provincias</h3>
        </div>
        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Provincia</th>
                <th>Distritos</th>
                <th>%</th>
                <th>Densidad</th>
              </tr>
            </thead>
            <tbody id="provinciaRanking">
              <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Análisis Geoespacial -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--accent-green);">🌍</div>
          <h3 class="card-title">Análisis Geoespacial</h3>
        </div>
        <div class="kpis-grid">
          <div class="kpi-card">
            <div class="kpi-value" id="geoLatPromedio">—</div>
            <div class="kpi-label">Latitud Promedio</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="geoLngPromedio">—</div>
            <div class="kpi-label">Longitud Promedio</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="geoRangoLat">—</div>
            <div class="kpi-label">Rango Latitudinal</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="geoRangoLng">—</div>
            <div class="kpi-label">Rango Longitudinal</div>
          </div>
        </div>
      </div>

      <!-- Distrito Seleccionado -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--accent-cyan);">📌</div>
          <h3 class="card-title">Distrito en Foco</h3>
        </div>
        <div id="selectedDistrictInfo">
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 48px; margin-bottom: 15px;">🎯</div>
            <p>Selecciona un distrito en el mapa para ver información detallada</p>
          </div>
        </div>
      </div>

      <!-- Análisis de Cobertura -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--accent-purple);">📡</div>
          <h3 class="card-title">Análisis de Cobertura Nacional</h3>
        </div>
        <div class="chart-container chart-small">
          <canvas id="coverageChart"></canvas>
        </div>
      </div>

      <!-- Tendencias Temporales -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">📈</div>
          <h3 class="card-title">Evolución del Sistema</h3>
        </div>
        <div class="chart-container chart-small">
          <canvas id="trendsChart"></canvas>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Scripts del Sistema -->
<script>
// Variables globales
let allRecords = [];
let filteredRecords = [];
let map, cluster, provincesLayer;
let charts = {};
let selectedCategories = new Set();

// Configuración
const CONFIG = {
  supabaseUrl: 'https://eunujfywdwipguopstru.supabase.co',
  supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1bnVqZnl3ZHdpcGd1b3BzdHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NzM3MDksImV4cCI6MjA3NDE0OTcwOX0.Jf-QSpS6K0yh_JCX1IVtEC8Amq1Or9XwLjc9dtsxLAs',
  csvFallback: 'data/distritos.csv',
  expectedTotal: 140
};

// Utilidades
function normalizeText(text) {
  return (text || '').toString()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase()
    .trim();
}

function getInstitutionColor(category) {
  const colors = {
    'MINEDUC': '#2563eb',
    'SENECYT': '#10b981',
    'SENECYT - ZONA DEPORTE': '#06b6d4',
    'ZONA DEPORTE': '#f59e0b',
    'OT DEPORTE': '#ef4444'
  };
  
  for (const key in colors) {
    if (category && category.toUpperCase().includes(key)) {
      return colors[key];
    }
  }
  return '#6b7280'; // Color por defecto
}

function formatNumber(num) {
  return new Intl.NumberFormat('es-ES').format(num);
}

function formatCoordinate(coord) {
  return parseFloat(coord).toFixed(4);
}

// Inicialización del mapa
function initializeMap() {
  map = L.map('map', { 
    zoomControl: true,
    preferCanvas: true 
  }).setView([-1.8312, -78.1834], 6);

  // Capas base
  const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  });

  const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© Esri'
  });

  osmLayer.addTo(map);

  // Control de capas
  L.control.layers({
    'Mapa Base': osmLayer,
    'Vista Satelital': satelliteLayer
  }, {}, { collapsed: false }).addTo(map);

  // Cluster para marcadores
  cluster = L.markerClusterGroup({
    chunkedLoading: true,
    maxClusterRadius: 50,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    disableClusteringAtZoom: 12
  });

  map.addLayer(cluster);

  // Eventos del mapa
  map.on('zoomend', () => {
    document.getElementById('mapZoom').textContent = map.getZoom();
  });
}

// Carga de datos desde Supabase
async function loadDataFromSupabase() {
  try {
    if (!window.supabase) {
      throw new Error('Supabase no está disponible');
    }

    const client = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
    const { data, error } = await client
      .from('distritos')
      .select('*');

    if (error) throw error;

    return data.map(record => ({
      ...record,
      lat: parseFloat(record.Latitud),
      lng: parseFloat(record.Longitud),
      provincia: record.DPA_DESPRO || '',
      canton: record.DPA_DESCAN || '',
      complement: record.COMPLEMENT || 'SIN CATEGORÍA'
    })).filter(r => 
      isFinite(r.lat) && isFinite(r.lng) &&
      r.lat >= -5.8 && r.lat <= 2.2 &&
      r.lng >= -92.5 && r.lng <= -74.0
    );
  } catch (error) {
    console.warn('Error cargando desde Supabase:', error);
    return await loadDataFromCSV();
  }
}

// Carga de datos desde CSV (fallback)
async function loadDataFromCSV() {
  try {
    const response = await fetch(CONFIG.csvFallback);
    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }
    
    const csvText = await response.text();
    const parsed = Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      dynamicTyping: true
    });

    return parsed.data.map(record => ({
      ...record,
      lat: parseFloat(record.Latitud || record.latitud),
      lng: parseFloat(record.Longitud || record.longitud),
      provincia: record.DPA_DESPRO || record.provincia || '',
      canton: record.DPA_DESCAN || record.canton || '',
      complement: record.COMPLEMENT || record.complement || 'SIN CATEGORÍA'
    })).filter(r => 
      isFinite(r.lat) && isFinite(r.lng) &&
      r.lat >= -5.8 && r.lat <= 2.2 &&
      r.lng >= -92.5 && r.lng <= -74.0
    );
  } catch (error) {
    console.error('Error cargando CSV:', error);
    throw error;
  }
}

// Creación de marcadores
function createMarker(record) {
  const marker = L.circleMarker([record.lat, record.lng], {
    radius: 8,
    fillColor: getInstitutionColor(record.complement),
    color: '#ffffff',
    weight: 2,
    fillOpacity: 0.9,
    opacity: 1
  });

  // Popup con información detallada
  const popupContent = `
    <div style="font-family: 'Inter', sans-serif; min-width: 300px;">
      <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; margin: -8px -8px 15px; border-radius: 8px;">
        <h4 style="margin: 0; font-size: 16px; font-weight: 700;">${record.COD_DISTRI || ''}</h4>
        <p style="margin: 5px 0 0; opacity: 0.9; font-size: 14px;">${record.NOM_DISTRI || ''}</p>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
        <div><strong>Provincia:</strong><br>${record.provincia}</div>
        <div><strong>Cantón:</strong><br>${record.canton}</div>
        <div><strong>Tipo:</strong><br>${record.complement}</div>
        <div><strong>Coordenadas:</strong><br>${formatCoordinate(record.lat)}, ${formatCoordinate(record.lng)}</div>
      </div>
    </div>
  `;

  marker.bindPopup(popupContent, { 
    maxWidth: 400,
    autoPan: true 
  });

  marker.bindTooltip(record.COD_DISTRI || 'Distrito', {
    permanent: false,
    direction: 'top',
    opacity: 0.9
  });

  // Evento de clic
  marker.on('click', () => {
    showDistrictDetails(record);
  });

  return marker;
}

// Mostrar detalles del distrito
function showDistrictDetails(record) {
  const detailsContainer = document.getElementById('selectedDistrictInfo');
  
  detailsContainer.innerHTML = `
    <div class="detail-panel">
      <div class="detail-title">${record.NOM_DISTRI || 'Distrito'}</div>
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">Código</div>
          <div class="detail-value">${record.COD_DISTRI || '—'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Tipo Institucional</div>
          <div class="detail-value">${record.complement}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Provincia</div>
          <div class="detail-value">${record.provincia}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Cantón</div>
          <div class="detail-value">${record.canton}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Latitud</div>
          <div class="detail-value">${formatCoordinate(record.lat)}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Longitud</div>
          <div class="detail-value">${formatCoordinate(record.lng)}</div>
        </div>
      </div>
    </div>
  `;
}

// Actualización de la interfaz
function updateInterface() {
  // Estadísticas principales
  document.getElementById('totalRecords').textContent = formatNumber(allRecords.length);
  document.getElementById('filteredRecords').textContent = formatNumber(filteredRecords.length);
  
  // Header stats
  document.getElementById('headerTotalDistritos').textContent = CONFIG.expectedTotal;
  
  const provinces = [...new Set(allRecords.map(r => r.provincia))].filter(Boolean);
  const cantons = [...new Set(allRecords.map(r => r.canton))].filter(Boolean);
  
  document.getElementById('headerProvincias').textContent = provinces.length;
  document.getElementById('headerCantones').textContent = cantons.length;
  
  // KPIs del dashboard
  document.getElementById('kpiTotalDistritos').textContent = formatNumber(CONFIG.expectedTotal);
  document.getElementById('kpiProvincias').textContent = formatNumber(provinces.length);
  document.getElementById('kpiCantones').textContent = formatNumber(cantons.length);
  document.getElementById('kpiVisible').textContent = formatNumber(filteredRecords.length);

  // Análisis geoespacial
  if (allRecords.length > 0) {
    const lats = allRecords.map(r => r.lat);
    const lngs = allRecords.map(r => r.lng);
    
    const avgLat = lats.reduce((a, b) => a + b, 0) / lats.length;
    const avgLng = lngs.reduce((a, b) => a + b, 0) / lngs.length;
    const rangeLat = Math.max(...lats) - Math.min(...lats);
    const rangeLng = Math.max(...lngs) - Math.min(...lngs);
    
    document.getElementById('geoLatPromedio').textContent = formatCoordinate(avgLat);
    document.getElementById('geoLngPromedio').textContent = formatCoordinate(avgLng);
    document.getElementById('geoRangoLat').textContent = formatCoordinate(rangeLat) + '°';
    document.getElementById('geoRangoLng').textContent = formatCoordinate(rangeLng) + '°';
  }

  updateCharts();
  updateRanking();
}

// Actualización de gráficos
function updateCharts() {
  updateProvinceChart();
  updateInstitutionChart();
  updateCoverageChart();
  updateTrendsChart();
}

function updateProvinceChart() {
  const ctx = document.getElementById('provinciaChart').getContext('2d');
  
  if (charts.provincia) {
    charts.provincia.destroy();
  }

  // Contar distritos por provincia
  const provinceCounts = {};
  allRecords.forEach(record => {
    const prov = record.provincia || 'Sin provincia';
    provinceCounts[prov] = (provinceCounts[prov] || 0) + 1;
  });

  const sortedProvinces = Object.entries(provinceCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  charts.provincia = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedProvinces.map(([name]) => name.length > 15 ? name.substring(0, 12) + '...' : name),
      datasets: [{
        data: sortedProvinces.map(([, count]) => count),
        backgroundColor: 'rgba(59, 130, 246, 0.7)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#9CA3AF', font: { size: 11 } },
          grid: { color: 'rgba(156, 163, 175, 0.1)' }
        },
        x: {
          ticks: { color: '#9CA3AF', font: { size: 10 } },
          grid: { display: false }
        }
      }
    }
  });
}

function updateInstitutionChart() {
  const ctx = document.getElementById('institutionChart').getContext('2d');
  
  if (charts.institution) {
    charts.institution.destroy();
  }

  // Contar por tipo institucional
  const institutionCounts = {};
  allRecords.forEach(record => {
    const inst = record.complement || 'Sin categoría';
    institutionCounts[inst] = (institutionCounts[inst] || 0) + 1;
  });

  const colors = ['#2563eb', '#10b981', '#06b6d4', '#f59e0b', '#ef4444', '#6b7280'];

  charts.institution = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(institutionCounts),
      datasets: [{
        data: Object.values(institutionCounts),
        backgroundColor: colors,
        borderColor: '#1F2937',
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#D1D5DB',
            font: { size: 11 },
            padding: 15,
            usePointStyle: true
          }
        }
      }
    }
  });
}

function updateCoverageChart() {
  const ctx = document.getElementById('coverageChart').getContext('2d');
  
  if (charts.coverage) {
    charts.coverage.destroy();
  }

  // Datos simulados de cobertura
  const coverageData = {
    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
    datasets: [{
      label: 'Cobertura Nacional (%)',
      data: [95.2, 96.1, 97.3, 97.8, 98.1, 98.5],
      borderColor: '#10b981',
      backgroundColor: 'rgba(16, 185, 129, 0.1)',
      fill: true,
      tension: 0.4
    }]
  };

  charts.coverage = new Chart(ctx, {
    type: 'line',
    data: coverageData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: 90,
          max: 100,
          ticks: { color: '#9CA3AF', font: { size: 11 } },
          grid: { color: 'rgba(156, 163, 175, 0.1)' }
        },
        x: {
          ticks: { color: '#9CA3AF', font: { size: 11 } },
          grid: { display: false }
        }
      }
    }
  });
}

function updateTrendsChart() {
  const ctx = document.getElementById('trendsChart').getContext('2d');
  
  if (charts.trends) {
    charts.trends.destroy();
  }

  // Datos simulados de evolución
  const trendsData = {
    labels: ['2020', '2021', '2022', '2023', '2024', '2025'],
    datasets: [
      {
        label: 'Distritos Activos',
        data: [125, 130, 135, 137, 139, 140],
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true
      },
      {
        label: 'Digitalización (%)',
        data: [45, 60, 75, 85, 92, 98],
        borderColor: '#8b5cf6',
        backgroundColor: 'rgba(139, 92, 246, 0.1)',
        fill: true
      }
    ]
  };

  charts.trends = new Chart(ctx, {
    type: 'line',
    data: trendsData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#D1D5DB',
            font: { size: 10 },
            padding: 10
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#9CA3AF', font: { size: 10 } },
          grid: { color: 'rgba(156, 163, 175, 0.1)' }
        },
        x: {
          ticks: { color: '#9CA3AF', font: { size: 10 } },
          grid: { display: false }
        }
      }
    }
  });
}

function updateRanking() {
  // Contar distritos por provincia
  const provinceCounts = {};
  allRecords.forEach(record => {
    const prov = record.provincia || 'Sin provincia';
    provinceCounts[prov] = (provinceCounts[prov] || 0) + 1;
  });

  const ranking = Object.entries(provinceCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  const tbody = document.getElementById('provinciaRanking');
  tbody.innerHTML = ranking.map(([provincia, count], index) => {
    const percentage = ((count / allRecords.length) * 100).toFixed(1);
    const density = (count / 1000).toFixed(2); // Densidad simulada
    
    return `
      <tr>
        <td style="font-weight: 700; color: var(--accent-blue);">${index + 1}</td>
        <td>${provincia}</td>
        <td>${formatNumber(count)}</td>
        <td>${percentage}%</td>
        <td>${density}/km²</td>
      </tr>
    `;
  }).join('');
}

// Renderizado del mapa
function renderMap() {
  cluster.clearLayers();
  
  filteredRecords.forEach(record => {
    const marker = createMarker(record);
    cluster.addLayer(marker);
  });

  // Ajustar vista si hay datos filtrados
  if (filteredRecords.length > 0) {
    const group = new L.featureGroup(cluster.getLayers());
    if (group.getBounds().isValid()) {
      map.fitBounds(group.getBounds(), { padding: [20, 20] });
    }
  }
}

// Aplicar filtros
function applyFilters() {
  const searchTerm = normalizeText(document.getElementById('searchInput').value);
  const selectedProvince = document.getElementById('provinciaSelect').value;
  const selectedCanton = document.getElementById('cantonSelect').value;

  filteredRecords = allRecords.filter(record => {
    // Filtro de búsqueda
    if (searchTerm) {
      const searchText = normalizeText(`${record.COD_DISTRI || ''} ${record.NOM_DISTRI || ''} ${record.provincia} ${record.canton}`);
      if (!searchText.includes(searchTerm)) {
        return false;
      }
    }

    // Filtro de provincia
    if (selectedProvince && record.provincia !== selectedProvince) {
      return false;
    }

    // Filtro de cantón
    if (selectedCanton && record.canton !== selectedCanton) {
      return false;
    }

    // Filtro de categorías
    if (selectedCategories.size > 0 && !selectedCategories.has(record.complement)) {
      return false;
    }

    return true;
  });

  renderMap();
  updateInterface();
}

// Configurar controles
function setupControls() {
  // Búsqueda
  document.getElementById('searchInput').addEventListener('input', applyFilters);

  // Selectores
  document.getElementById('provinciaSelect').addEventListener('change', (e) => {
    const selectedProvince = e.target.value;
    updateCantonSelector(selectedProvince);
    document.getElementById('selectedProvince').textContent = selectedProvince || 'Todas';
    applyFilters();
  });

  document.getElementById('cantonSelect').addEventListener('change', applyFilters);

  // Botones
  document.getElementById('clearFilters').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('provinciaSelect').value = '';
    document.getElementById('cantonSelect').innerHTML = '<option value="">Todos los Cantones</option>';
    document.getElementById('selectedProvince').textContent = 'Todas';
    selectedCategories.clear();
    document.querySelectorAll('.chip.active').forEach(chip => {
      chip.classList.remove('active');
    });
    applyFilters();
  });

  document.getElementById('exportData').addEventListener('click', exportFilteredData);
  document.getElementById('refreshData').addEventListener('click', () => location.reload());
}

function updateCantonSelector(province) {
  const cantonSelect = document.getElementById('cantonSelect');
  cantonSelect.innerHTML = '<option value="">Todos los Cantones</option>';

  if (province) {
    const cantons = [...new Set(
      allRecords
        .filter(r => r.provincia === province)
        .map(r => r.canton)
        .filter(Boolean)
    )].sort();

    cantons.forEach(canton => {
      const option = document.createElement('option');
      option.value = canton;
      option.textContent = canton;
      cantonSelect.appendChild(option);
    });
  }
}

function setupCategoryChips() {
  const categories = {};
  allRecords.forEach(record => {
    const cat = record.complement || 'Sin categoría';
    categories[cat] = (categories[cat] || 0) + 1;
  });

  const container = document.getElementById('categoryChips');
  container.innerHTML = '';

  Object.entries(categories)
    .sort((a, b) => b[1] - a[1])
    .forEach(([category, count]) => {
      const chip = document.createElement('button');
      chip.className = 'chip';
      chip.textContent = `${category} (${count})`;
      
      chip.addEventListener('click', () => {
        if (selectedCategories.has(category)) {
          selectedCategories.delete(category);
          chip.classList.remove('active');
        } else {
          selectedCategories.add(category);
          chip.classList.add('active');
        }
        applyFilters();
      });

      container.appendChild(chip);
    });
}

function setupProvinceSelector() {
  const provinces = [...new Set(allRecords.map(r => r.provincia))].filter(Boolean).sort();
  const select = document.getElementById('provinciaSelect');
  
  provinces.forEach(province => {
    const option = document.createElement('option');
    option.value = province;
    option.textContent = province;
    select.appendChild(option);
  });
}

function exportFilteredData() {
  if (filteredRecords.length === 0) {
    alert('No hay datos filtrados para exportar');
    return;
  }

  const headers = ['COD_DISTRI', 'NOM_DISTRI', 'DPA_DESPRO', 'DPA_DESCAN', 'COMPLEMENT', 'Latitud', 'Longitud'];
  const csvContent = [
    headers.join(','),
    ...filteredRecords.map(record => 
      headers.map(header => `"${(record[header] || '').toString().replace(/"/g, '""')}"`).join(',')
    )
  ].join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `distritos_filtrados_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

// Inicialización principal
async function initialize() {
  try {
    // Inicializar mapa
    initializeMap();

    // Cargar datos
    allRecords = await loadDataFromSupabase();
    filteredRecords = [...allRecords];

    if (allRecords.length === 0) {
      throw new Error('No se pudieron cargar los datos');
    }

    // Configurar interfaz
    setupProvinceSelector();
    setupCategoryChips();
    setupControls();

    // Renderizar todo
    renderMap();
    updateInterface();

    // Centrar mapa en datos
    if (allRecords.length > 0) {
      const avgLat = allRecords.reduce((sum, r) => sum + r.lat, 0) / allRecords.length;
      const avgLng = allRecords.reduce((sum, r) => sum + r.lng, 0) / allRecords.length;
      map.setView([avgLat, avgLng], 6);
    }

    console.log(`✅ Sistema iniciado con ${allRecords.length} registros`);

  } catch (error) {
    console.error('Error inicializando el sistema:', error);
    alert('Error cargando el sistema. Verifica la conexión y los datos.');
  } finally {
    // Ocultar loading
    document.getElementById('loading').style.display = 'none';
    
    // Agregar animaciones
    document.querySelectorAll('.fade-in').forEach((el, index) => {
      setTimeout(() => {
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      }, index * 200);
    });
  }
}

// Iniciar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', initialize);
</script>

</body>
</html>
