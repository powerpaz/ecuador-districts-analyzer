<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mapa Educativo – Ecuador</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" defer></script>
  <style>
    :root{
      --brand1:#667eea; --brand2:#764ba2; --bg:#0b1020; --header-h:56px;
      --panel-w:340px; --radius:14px; --shadow:0 10px 25px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:#111}

    header{
      position:sticky;top:0;z-index:1000;height:var(--header-h);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      padding:10px 14px;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.15);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:#fff;opacity:.9}
    .actions{display:flex;align-items:center;gap:8px}
    .btn{appearance:none;border:0;border-radius:12px;padding:8px 12px;background:#fff;color:#333;font-weight:600;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .btn:hover{filter:brightness(.98)}

    /* Layout */
    #app{position:relative;}
    #map{height:calc(100dvh - var(--header-h)); width:100%;}

    /* Panel (drawer on mobile, sidebar on desktop) */
    #panel{
      position:fixed; inset:auto 0 0 auto; top:var(--header-h);
      width:min(100vw, var(--panel-w)); max-width:100vw; height:calc(100dvh - var(--header-h));
      background:#fff;border-left:1px solid #e9ecef;box-shadow:var(--shadow);
      transform:translateX(100%); transition:transform .28s ease; z-index:1001;
      display:flex;flex-direction:column;
    }
    #panel.open{transform:translateX(0)}
    #panel .panel-head{padding:14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    #panel .panel-body{padding:14px;overflow:auto}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .card{border:1px solid #eee;border-radius:12px;padding:12px; text-align:center; background:#fafafa}
    .num{font-size:clamp(18px,4vw,24px);font-weight:800}
    .lbl{font-size:12px;color:#666}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #eee;border-radius:20px;padding:6px 10px;background:#fff}
    .swatch{width:12px;height:12px;border-radius:50%}

    /* Overlay (backdrop) for mobile */
    #backdrop{position:fixed;inset:0; background:rgba(0,0,0,.25); z-index:1000; opacity:0; pointer-events:none; transition:opacity .25s}
    #backdrop.show{opacity:1;pointer-events:auto}

    /* Desktop: show persistent sidebar */
    @media(min-width: 1024px){
      #app{display:grid; grid-template-columns: var(--panel-w) 1fr;}
      #panel{position:relative; transform:none; height:calc(100vh - var(--header-h)); top:0; box-shadow:none}
      #backdrop{display:none}
      #map{height:calc(100vh - var(--header-h));}
      .btn.mobile-only{display:none}
    }

    /* Leaflet tweaks for mobile popups */
    .leaflet-popup-content{font-size:14px;max-width:min(320px, 80vw)}
    .leaflet-control-zoom a{width:34px;height:34px;line-height:34px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="dot"></span>
      <div>Mapa Educativo – Ecuador</div>
    </div>
    <div class="actions">
      <button id="btnPanel" class="btn mobile-only" aria-controls="panel" aria-expanded="false">Estadísticas</button>
    </div>
  </header>

  <div id="app">
    <aside id="panel" aria-label="Panel de estadísticas">
      <div class="panel-head">
        <strong>Resumen</strong>
        <button id="btnClose" class="btn mobile-only">Cerrar</button>
      </div>
      <div class="panel-body">
        <div class="kpi">
          <div class="card"><div id="k-puntos" class="num">0</div><div class="lbl">Puntos</div></div>
          <div class="card"><div id="k-inst" class="num">0</div><div class="lbl">Instituciones</div></div>
          <div class="card"><div id="k-est" class="num">0</div><div class="lbl">Estudiantes</div></div>
        </div>
        <div>
          <strong>Capas</strong>
          <div class="legend" id="legend">
            <span class="badge"><span class="swatch" style="background:#2e7d32"></span>Fiscal</span>
            <span class="badge"><span class="swatch" style="background:#f57c00"></span>Fiscom.</span>
            <span class="badge"><span class="swatch" style="background:#d32f2f"></span>Particular</span>
            <span class="badge"><span class="swatch" style="background:#1976d2"></span>Otro</span>
          </div>
        </div>
        <hr style="margin:14px 0;border:none;border-top:1px solid #eee"/>
        <details>
          <summary><strong>Acerca del dataset</strong></summary>
          <p style="font-size:13px;color:#555">Este mapa carga <code>provincias.geojson</code> (opcional) y <code>instituciones.geojson</code> (requerido) desde la raíz del repositorio.</p>
        </details>
      </div>
    </aside>

    <div id="map" role="region" aria-label="Mapa interactivo"></div>
  </div>
  <div id="backdrop" aria-hidden="true"></div>

  <script>
    // Fix 100vh in mobile (address bar)
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px'); }
    setVH(); window.addEventListener('resize', setVH);
  </script>
  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    const btnPanel = document.getElementById('btnPanel');
    const btnClose = document.getElementById('btnClose');
    const panel = document.getElementById('panel');
    const backdrop = document.getElementById('backdrop');

    const openPanel = () => { panel.classList.add('open'); backdrop.classList.add('show'); btnPanel.setAttribute('aria-expanded','true'); }
    const closePanel = () => { panel.classList.remove('open'); backdrop.classList.remove('show'); btnPanel.setAttribute('aria-expanded','false'); }
    btnPanel?.addEventListener('click', openPanel);
    btnClose?.addEventListener('click', closePanel);
    backdrop?.addEventListener('click', closePanel);

    // Map
    const map = L.map('map', { preferCanvas:true }).setView([-1.8312, -78.1834], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap contributors', maxZoom: 18 }).addTo(map);

    // Provincias (opcional)
    try {
      const r = await fetch('provincias.geojson');
      if(r.ok){
        const geo = await r.json();
        const prov = L.geoJSON(geo, { style:{ color:'#555', weight:1, fillOpacity:0.05 } });
        prov.addTo(map);
        try { map.fitBounds(prov.getBounds(), { padding:[20,20] }); } catch{}
      }
    } catch(e){ console.warn('provincias.geojson no encontrado'); }

    // Instituciones (requerido)
    const cluster = L.markerClusterGroup({ chunkedLoading:true, showCoverageOnHover:false, maxClusterRadius:50 });
    let totalEst = 0;
    try {
      const r2 = await fetch('instituciones.geojson');
      if(!r2.ok) throw new Error('instituciones.geojson no disponible');
      const gj = await r2.json();
      const puntos = L.geoJSON(gj, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius: 6, color:'#fff', weight:1.5, fillColor: colorBySost(f.properties?.NOM_SOSTENIMIENTO), fillOpacity:0.95
        }),
        onEachFeature: (f, layer) => {
          const p = f.properties || {}; totalEst += (p.TOTAL_ESTUDIANTES? Number(p.TOTAL_ESTUDIANTES) : 0);
          const nombre = safe(p.NOM_INSTITUCION_EDUCATIVA,'Institución');
          const amie = safe(p.AMIE,'—');
          const sost = safe(p.NOM_SOSTENIMIENTO,'—');
          const prov = safe(p.DPA_DESPRO,'—');
          const reg  = safe(p.REGIMEN,'—');
          const est  = (p.TOTAL_ESTUDIANTES!=null)? Number(p.TOTAL_ESTUDIANTES).toLocaleString() : '—';
          layer.bindPopup(`<b>${nombre}</b><br>AMIE: ${amie}<br>Sostenimiento: ${sost}<br>Provincia: ${prov}<br>Régimen: ${reg}<br>Estudiantes: ${est}`);
        }
      });
      cluster.addLayer(puntos); map.addLayer(cluster);

      // KPIs
      document.getElementById('k-puntos').textContent = puntos.getLayers().length.toLocaleString();
      document.getElementById('k-inst').textContent = puntos.getLayers().length.toLocaleString();
      document.getElementById('k-est').textContent = totalEst.toLocaleString();

      // Auto-fit si no hubo provincias
      if(!map._zoomChanged){ try{ map.fitBounds(cluster.getBounds(), {padding:[20,20]}); }catch{} }
    } catch(e){
      console.error(e);
      toast('No se encontró <code>instituciones.geojson</code>. Súbelo a la raíz del repo.');
    }

    // Helpers
    function colorBySost(k){
      const K = (k||'').toString().toUpperCase();
      if(K==='FISCAL') return '#2e7d32';
      if(K.includes('FISCOM')) return '#f57c00';
      if(K==='PARTICULAR') return '#d32f2f';
      return '#1976d2';
    }
    function safe(v, d){ return (v==null||v==='')? d : v; }

    // Tiny toast for messages
    function toast(html){
      const t = document.createElement('div');
      t.style.cssText = 'position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);z-index:2000;max-width:92vw;font-size:14px';
      t.innerHTML = html; document.body.appendChild(t);
      setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0'; setTimeout(()=>t.remove(), 320); }, 2800);
    }
  });
  </script>
</body>
</html>




